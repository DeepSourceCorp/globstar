language: py
name: post-after-isvalid
message: Detected request.POST after an is_valid() check
category: security

pattern: |
  (subscript
    value: (attribute
      object: (identifier) @request
      attribute: (identifier) @post)
    subscript: (_)
    (#eq? @request "request")
    (#eq? @post "POST")) @post-after-isvalid

  (call
    function: (attribute
      object: (attribute
        object: (identifier) @request
        attribute: (identifier) @post)
      attribute: (identifier) @get)
    (#eq? @request "request")
    (#eq? @post "POST")
    (#eq? @get "get")) @post-after-isvalid

filters:
  - pattern-inside: |
      (if_statement
        condition: (call
          function: (attribute
            object: (identifier)
            attribute: (identifier) @isvalid)
          arguments: (argument_list))
        (#eq? @isvalid "is_valid"))

description: |
  Use form.cleaned_data[] instead of request.POST[]/request.POST.get() after form.is_valid() to access only sanitized data