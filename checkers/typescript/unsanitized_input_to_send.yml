language: ts
name: unsanitized_input_to_send
message: Detected unsanitized input being passed to send 
category: security

pattern: |
  (
  (import_statement
    (import_clause
        (identifier) @pack_name (#eq @pack_name "express"))
  
  )
  (lexical_declaration
    (variable_declarator
        name : (identifier) @express_declaration
      )
  )
  (expression_statement
    (call_expression
        function : (member_expression
            object : (identifier)  @invoke_name (#eq @invoke_name @express_declaration)
              property : (property_identifier) @property (#eq @property "use")
              
          )
          (arguments
          
          [(
            (arrow_function
              parameters : (formal_parameters
                    (required_parameter
                        pattern : (identifier) @var_name
                          type : (type_annotation
                            (type_identifier) @type 
                          )
                        
                  
                      ) 
                  )
                  body : (_
                    (lexical_declaration
                        (variable_declarator
                            name : (object_pattern
                                (shorthand_property_identifier_pattern) @vars
                              )
                          )
                            
                        
                      )
                      [(if_statement
                        consequence : (_
                            (return_statement
                                (call_expression
                                      function : (member_expression
                                        object : [(call_expression
                                                )
                                                (identifier)
                                                  ]
                                          property : (property_identifier) @send_prop (#eq? @send_prop "send")
                                
                                  )
                                      arguments : (arguments
                                      (template_string
                                          (template_substitution
                                              (identifier) @unsani_var_name(#match @unsani_var_name@vars)
                                          )
                                      ) 
                                  )

                                  
                                  )
                              ) 
                          )
                      ) 
                      (return_statement
                        (call_expression
                            function : (member_expression
                                object : (identifier
                                    
                                  ) @resp_var_name (#match @resp_var_name @var_name )
                                  property :(_) @send_func (#eq? @send_func "send")
                                  
                              )
                              arguments : (arguments
                                (template_string
                                    (template_substitution
                                        (identifier) @unsanitized_input (#match @unsanitized_input @vars)
                                    )
                                  ) 
                              )
                          )
                      ) 
                      ]
                  )
            ) 
          )
          ]        
          )
      )
  )

  ) @unsanitized_input_to_send

description: |
  Unsanitized input from an HTTP parameter flows into send, where it is used to render an HTML page returned to the user. This may result in a Cross-Site Scripting attack (XSS).

