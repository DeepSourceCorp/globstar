language: ts
name: no_origin_detect
message: Missing Origin Validation in WebSocket Connection , Please validate with allowed origins
category: security

pattern: |
  (call_expression
      function: (member_expression
          object: (identifier) @wss (#match? @wss "^(wss|ws)$")
          property: (property_identifier) @on (#eq? @on "on")
          
      )         
      arguments: (arguments
          (string
              (string_fragment) @event_name (#eq? @event_name "connection")
          )
          (arrow_function
          	  parameters : (formal_parameters
              	(required_parameter
                	pattern : (identifier) @inputws (#eq? @inputws "ws") 
                 ) 
                 (required_parameter
                	pattern : (identifier) @inputreq (#eq? @inputreq "req") 
                 ) 
               )
    
              body : (statement_block
                  (_)* @lines
                  (#not-match? @lines "if\\s*\\(\\s*origin\\s*!==") 
              ) 
          )
       )       
  ) @no_origin_detect

description: |
  The WebSocket connection handler does not validate the request's Origin, allowing connections from untrusted sources. This can lead to Cross-Site WebSocket Hijacking (CSWSH), where malicious websites initiate unauthorized WebSocket connections to your server

