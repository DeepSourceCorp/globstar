language: py
name: py_direct_httpresponse
message:  Detected data rendered directly to the end user via 'HttpResponse' or a similar object
category: security
severity: warning

pattern: |
  (call
    function: (attribute
      object: (attribute
        object: (identifier) @django
        attribute: (identifier) @http)
      attribute: (identifier) @response)
    arguments: (argument_list
      .
      [(call
        function: (attribute
          object: (string)
          attribute: (identifier))
        arguments: (argument_list))
        (string
          (interpolation
            (_)))
        (binary_operator
          left: (string)
          right: (_))
        (call
          function: (attribute
            object: (call
              function: (identifier)
                arguments: (argument_list
                  (string)))
            attribute: (identifier))
            arguments: (argument_list))
      ]
      (_)*
      [
        (keyword_argument  ; optional keyword argument
        name: (identifier) @kw
        value: (string) @content_type)
       (keyword_argument
        name: (identifier) @content
        value: (none)
        (#not-eq? @content "content"))
       (keyword_argument
        name: (identifier) @status
        value: (integer)
        (#not-eq? @status "status")
        (#eq? @status "status"))
      (_)*])
    (#eq? @django "django")
    (#eq? @http "http")
    (#eq? @kw "content_type")
    (#match? @content_type ".*[tT][eE][xX][tT]/[hH][tT][mM][lL].*")
    (#match? @response "^(HttpResponseBadRequest|HttpResponse|HttpResponseNotFound|HttpResponseGone|HttpResponseForbidden|HttpResponseServerError|HttpResponseNotAllowed)$")) @py_direct_httpresponse
  
  (call
    function: (identifier) @response
    arguments: (argument_list
      .
      [(call
        function: (attribute
          object: (string)
          attribute: (identifier))
        arguments: (argument_list))
        (string
        (interpolation
          (_)))
        (binary_operator
        left: (string)
        right: (_))

      (call
        function: (attribute
          object: (call
            function: (identifier)
              arguments: (argument_list
                (string)))
          attribute: (identifier))
          arguments: (argument_list))
      (argument_list 
        (identifier))
      ]
      (_)*
      [
        (keyword_argument  ; optional keyword argument
          name: (identifier) @kw
          value: (string) @content_type)
        (keyword_argument
          name: (identifier) @content
          value: (none)
          (#not-eq? @content "content"))
        (keyword_argument
          name: (identifier) @status
          value: (integer)
          (#not-eq? @status "status")
          (#eq? @status "status"))
        (_)*
      ])
    (#eq? @kw "content_type")
    (#match? @content_type ".*[tT][eE][xX][tT]/[hH][tT][mM][lL].*")
    (#match? @response "^(HttpResponseBadRequest|HttpResponse|HttpResponseNotFound|HttpResponseGone|HttpResponseForbidden|HttpResponseServerError|HttpResponseNotAllowed)$")) @py_direct_httpresponse

  (call
    function: (identifier) @response
    arguments: (argument_list
      [(identifier)
       (integer)
       (float)
       (true)
       (false)
       (none)
       (list)
       (tuple)
       (dictionary)
       (call)
      [
        (keyword_argument  ; optional keyword argument
          name: (identifier) @kw
          value: (string) @content_type)
        (keyword_argument
          name: (identifier) @content
          value: (none)
          (#eq? @content "content"))
        (keyword_argument
          name: (identifier) @status
          value: (integer)
          (#eq? @status "status")
          (#eq? @status "status"))
      (_)*]])
    (#eq? @kw "content_type")
    (#match? @content_type ".*[tT][eE][xX][tT]/[hH][tT][mM][lL].*")
    (#match? @response "^(HttpResponseBadRequest|HttpResponse|HttpResponseNotFound|HttpResponseGone|HttpResponseForbidden|HttpResponseServerError|HttpResponseNotAllowed)$")) @py_direct_httpresponse


description: |
  Rendering data directly to the end user via 'HttpResponse' or a similar object bypasses Django's built-in cross-site scripting(XSS) defenses and could result in an XSS vulnerability. Use Django's template engine to safely render HTML

