language: py
name: raw_html
message: Detected user input flowing into a manually constructed HTML string.
category: security

pattern: |
  (call
    function: (attribute
      object: (string
        (string_content) @htmlstr)
      attribute: (identifier) @format)
    arguments: (argument_list
      (call
        function: (attribute
          object: (identifier) @request
          attribute: (identifier) @method)
        arguments: (argument_list)))
    (#match? @htmlstr ".*<[^>]+>.*")
    (#eq? @format "format")
    (#eq? @request "request")
    (#match? @method "^(GET|POST)$")) @raw_html

  (call
    function: (attribute
      object: (string
        (string_content) @htmlstr)
      attribute: (identifier) @format)
    arguments: (argument_list
      (subscript
        value: (attribute
          object: (identifier) @request
          attribute: (identifier) @method)
        subscript: (_)))
    (#match? @htmlstr ".*<[^>]+>.*")
    (#eq? @format "format")
    (#eq? @request "request")
    (#match? @method "^(GET|POST)$")) @raw_html

  (binary_operator
    left: (string
      (string_content) @htmlstr)
    right: (call
      function: (attribute
        object: (identifier) @request
        attribute: (identifier) @method)
      arguments: (argument_list))
    (#match? @htmlstr ".*<[^>]+>.*")
    (#eq? @request "request")
    (#match? @method "^(GET|POST)$")) @raw_html

  (binary_operator
    left: (string
      (string_content) @htmlstr)
    right: (subscript
      value: (attribute
        object: (identifier) @request
        attribute: (identifier) @method)
      subscript: (_))
    (#match? @htmlstr ".*<[^>]+>.*")
    (#eq? @request "request")
    (#match? @method "^(GET|POST)$")) @raw_html

  (string
    (string_start)
    (string_content) @htmlstr1
    (interpolation
      expression: (call
        function: (attribute
          object: (identifier) @request
          attribute: (identifier) @method)
        arguments: (argument_list)))
    (string_content) @htmlstr2
    (string_end)
    (#eq? @request "request")
    (#match? @htmlstr1 ".*<[^>]")
    (#match? @htmlstr2 "[^<]+>.*")
    (#match? @method "^(GET|POST)$")) @raw_html

  (string
    (string_start)
    (string_content) @htmlstr1
    (interpolation
      expression: (subscript
        value: (attribute
          object: (identifier) @request
          attribute: (identifier) @method)
        subscript: (_)))
    (string_content) @htmlstr2
    (string_end)
    (#eq? @request "request")
    (#match? @htmlstr1 ".*<[^>]")
    (#match? @htmlstr2 "[^<]+>.*")
    (#match? @method "^(GET|POST)$")) @raw_html

  (function_definition
    body: (block
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @html_var
          right: (string
            (string_content) @htmlstr)))
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @request_var
          right: (call
            function: (attribute
              object: (identifier) @request
              attribute: (identifier) @method)
            arguments: (argument_list))))
      (_)*
      (expression_statement
        (assignment
          left: (identifier)
          right: (binary_operator
            left: (identifier) @unsafe_left
            right: (identifier) @unsafe_right)))
      (_)*)
      (#eq? @request "request")
      (#match? @htmlstr ".*<[^>]+>.*")
      (#match? @method "^(GET|POST)$")
      (#eq? @html_var @unsafe_left)
      (#eq? @request_var @unsafe_right)) @raw_html

  (function_definition
    body: (block
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @html_var
          right: (string
            (string_content) @htmlstr)))
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @request_var
          right: (subscript
            value: (attribute
              object: (identifier) @request
              attribute: (identifier) @method)
            subscript: (_))))
      (_)*
      (expression_statement
        (assignment
          left: (identifier)
          right: (binary_operator
            left: (identifier) @unsafe_left
            right: (identifier) @unsafe_right)))
      (_)*)
      (#eq? @request "request")
      (#match? @htmlstr ".*<[^>]+>.*")
      (#match? @method "^(GET|POST)$")
      (#eq? @html_var @unsafe_left)
      (#eq? @request_var @unsafe_right)) @raw_html

  (function_definition
    body: (block
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @html_var
          right: (string
            (string_content) @htmlstr)))
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @request_var
          right: (call
            function: (attribute
              object: (identifier) @request
              attribute: (identifier) @method)
            arguments: (argument_list))))
      (_)*
      (expression_statement
        (assignment
          left: (identifier)
          right: (call
            function: (attribute
              object: (identifier) @unsafe_left
              attribute: (identifier) @format)
            arguments: (argument_list))))
      (_)*)
      (#eq? @request "request")
      (#match? @htmlstr ".*<[^>]+>.*")
      (#match? @method "^(GET|POST)$")
      (#eq? @html_var @unsafe_left)
      (#eq? @format "format")
      (#eq? @request_var @unsafe_right)) @raw_html

  (function_definition
    body: (block
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @html_var
          right: (string
            (string_content) @htmlstr)))
      (_)*
      (expression_statement
        (assignment
          left: (identifier) @request_var
          right: (subscript
            value: (attribute
              object: (identifier) @request_var
              attribute: (identifier) @method)
            subscript: (_))))
      (_)*
      (expression_statement
        (assignment
          left: (identifier)
          right: (call
            function: (attribute
              object: (identifier) @unsafe_left
              attribute: (identifier) @format)
            arguments: (argument_list))))
      (_)*)
      (#eq? @request "request")
      (#match? @htmlstr ".*<[^>]+>.*")
      (#match? @method "^(GET|POST)$")
      (#eq? @html_var @unsafe_left)
      (#eq? @format "format")
      (#eq? @request_var @unsafe_right)) @raw_html      


description: |
  Detected user input flowing into a manually constructed HTML string. You may be accidentally bypassing secure methods of rendering HTML by manually constructing HTML and this could create a cross-site scripting vulnerability, which could let attackers steal sensitive user data. To be sure this is safe, check that the HTML is rendered safely. Otherwise, use templates (`django.shortcuts.render`) which will safely render HTML instead.

  Rule: python.django.security.injection.raw-html-format.raw-html-format




